<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-O Ø§Ù„Ù…Ø­ØªØ±ÙÙŠÙ†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù„Ù„ØªØµÙ…ÙŠÙ… -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Tajawal', sans-serif; 
            background: radial-gradient(circle at center, #1f293a 0%, #0f172a 100%);
            color: #fff; 
            overflow-x: hidden;
        }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .cell {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        
        .cell:hover:not(:disabled):not(.occupied) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .occupied { cursor: default; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø±Ù…ÙˆØ² */
        .x-mark { 
            color: #ef4444; 
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .o-mark { 
            color: #10b981; 
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .winning-cell { 
            background: rgba(251, 191, 36, 0.2) !important; 
            border-color: #fbbf24 !important;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.4) !important;
        }

        /* Ø²Ø± Ø§Ù„Ù†Ø³Ø® */
        .copy-btn {
            position: relative;
            overflow: hidden;
        }
        .copy-btn::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .copy-btn:hover::after { left: 100%; }

        /* Loader */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #fbbf24;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 selection:bg-yellow-500 selection:text-black">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© / Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-screen" class="w-full max-w-lg glass-panel p-8 rounded-3xl text-center transform transition-all duration-500 hover:scale-[1.01]">
        <div class="mb-6 flex justify-center">
            <i class="fas fa-gamepad text-6xl text-yellow-400 drop-shadow-lg"></i>
        </div>
        <h1 class="text-5xl font-black mb-2 tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-orange-500">
            X - O
        </h1>
        <p class="text-gray-400 mb-8 text-lg font-medium">ØªØ­Ø¯Ù‰ Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</p>
        
        <div class="mb-6 text-right relative">
            <label class="block mb-2 text-gray-300 font-bold text-sm mr-1">Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© (ID):</label>
            <div class="relative">
                <input type="text" id="room-id" 
                    class="w-full p-4 rounded-xl bg-gray-900/50 border border-gray-600 focus:outline-none focus:border-yellow-400 focus:ring-2 focus:ring-yellow-400/20 text-center text-2xl font-mono tracking-widest text-white transition-all placeholder-gray-600" 
                    placeholder="--- ---">
                <button onclick="generateRoomId()" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition" title="ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ">
                    <i class="fas fa-random"></i>
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2 mr-1">ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© Ø£ÙŠ Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… Ù„Ù„ØºØ±ÙØ©</p>
        </div>

        <div class="mb-8">
            <label class="block text-right mb-3 text-gray-300 font-bold text-sm mr-1">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ:</label>
            <div class="flex gap-4 justify-center">
                <button id="btn-choice-x" class="flex-1 py-4 bg-gray-800/50 rounded-xl border-2 border-transparent hover:bg-gray-700 transition group relative overflow-hidden" onclick="selectSymbol('X')">
                    <span class="relative z-10 text-3xl font-black text-gray-500 group-hover:text-red-400 transition-colors">X</span>
                </button>
                <button id="btn-choice-o" class="flex-1 py-4 bg-gray-800/50 rounded-xl border-2 border-transparent hover:bg-gray-700 transition group relative overflow-hidden" onclick="selectSymbol('O')">
                    <span class="relative z-10 text-3xl font-black text-gray-500 group-hover:text-green-400 transition-colors">O</span>
                </button>
            </div>
            <p id="selected-symbol-text" class="mt-3 text-sm text-gray-400 h-5 transition-all">Ø§Ø®ØªØ± Ø§Ù„Ø±Ù…Ø² Ù„Ù„Ø¨Ø¯Ø¡</p>
        </div>

        <button id="login-btn" onclick="joinGame()" disabled 
            class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-400 hover:to-orange-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg hover:shadow-orange-500/20 transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
            <span id="btn-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</span>
            <div id="btn-loader" class="loader"></div>
        </button>

        <div id="login-error" class="mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-300 text-sm hidden flex items-center gap-2 justify-center">
            <i class="fas fa-exclamation-circle"></i> <span id="error-text"></span>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨ -->
    <div id="game-screen" class="hidden w-full max-w-lg flex flex-col items-center">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="w-full glass-panel p-4 rounded-2xl shadow-2xl mb-6 flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-gray-800 p-2 rounded-lg">
                        <i class="fas fa-user text-gray-400"></i>
                    </div>
                    <div>
                        <span class="block text-[10px] text-gray-400 uppercase tracking-wide">Ø£Ù†Øª</span>
                        <span id="my-symbol-display" class="text-2xl font-black leading-none"></span>
                    </div>
                </div>

                <div class="bg-gray-900/60 px-6 py-2 rounded-full border border-gray-700 backdrop-blur-sm">
                    <span id="turn-indicator" class="text-sm font-bold text-gray-400 flex items-center gap-2">
                        <span class="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    </span>
                </div>

                <div class="flex items-center gap-3 text-left">
                    <div class="text-right">
                        <span class="block text-[10px] text-gray-400 uppercase tracking-wide">Ø§Ù„ØºØ±ÙØ©</span>
                        <span id="room-display" class="text-lg font-mono font-bold text-yellow-500 leading-none"></span>
                    </div>
                    <div class="bg-gray-800 p-2 rounded-lg cursor-pointer hover:bg-gray-700 transition" onclick="copyInviteLink()" title="Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©">
                        <i class="fas fa-link text-white"></i>
                    </div>
                </div>
            </div>

            <!-- Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© -->
            <div id="invite-section" class="bg-blue-600/20 border border-blue-500/30 rounded-xl p-3 flex justify-between items-center animate-pulse">
                <div class="flex items-center gap-2 text-blue-200 text-sm">
                    <i class="fas fa-share-alt"></i>
                    <span>Ø£Ø±Ø³Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ØµØ¯ÙŠÙ‚Ùƒ Ù„ÙŠØ¯Ø®Ù„ Ù…Ø¹Ùƒ ÙÙˆØ±Ø§Ù‹!</span>
                </div>
                <button onclick="copyInviteLink()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded-lg transition font-bold shadow-lg shadow-blue-600/20">
                    Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
                </button>
            </div>
        </div>

        <!-- Ø§Ù„Ø¨ÙˆØ±Ø¯ -->
        <div id="board" class="grid grid-cols-3 gap-3 w-full aspect-square glass-panel p-3 rounded-3xl shadow-2xl mb-6 relative">
             <!-- Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ù‡Ù†Ø§ -->
        </div>

        <!-- Ø§Ù„Ø­Ø§Ù„Ø© -->
        <div class="w-full text-center">
             <div id="opponent-status" class="glass-panel inline-flex items-center gap-2 px-6 py-2 rounded-full text-sm font-medium text-gray-400">
                <div class="loader w-4 h-4 border-2 border-gray-500 border-t-transparent"></div>
                Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø®ØµÙ…...
             </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
    <div id="result-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden backdrop-blur-md">
        <div class="bg-gray-800 border border-gray-700 p-8 rounded-3xl text-center max-w-sm w-full mx-6 shadow-2xl transform transition-all scale-100 relative overflow-hidden">
            <!-- Glow Effect -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-transparent via-yellow-500 to-transparent opacity-50"></div>
            
            <div id="result-icon" class="text-6xl mb-4 animate-bounce">ğŸ†</div>
            <h2 id="result-title" class="text-3xl font-black mb-2 text-white"></h2>
            <p id="result-message" class="text-gray-400 mb-8 font-medium"></p>
            
            <button onclick="resetGame()" class="w-full bg-white text-black font-black py-4 rounded-xl hover:bg-gray-200 transition-all transform hover:-translate-y-1 shadow-lg flex justify-center items-center gap-2">
                <i class="fas fa-redo"></i> Ø¬ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰
            </button>
        </div>
    </div>

    <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Toast) -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl border border-gray-700 flex items-center gap-3 transition-all duration-300 opacity-0 translate-y-10 pointer-events-none z-[60]">
        <i class="fas fa-check-circle text-green-500"></i>
        <span id="toast-msg">ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØªÙƒÙˆÙŠÙ† Firebase ---
        let firebaseConfig;
        let currentAppId;

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        } else {
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub (ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Authorized Domains ÙÙŠ Firebase)
            firebaseConfig = {
                apiKey: "AIzaSyD6MRZ7d7J1333erYoBrUGqocJNdGNjB7w",
                authDomain: "neew-aec2b.firebaseapp.com",
                databaseURL: "https://neew-aec2b-default-rtdb.firebaseio.com",
                projectId: "neew-aec2b",
                storageBucket: "neew-aec2b.firebasestorage.app",
                messagingSenderId: "70112873200",
                appId: "1:70112873200:web:b8ef2b3863be6f1bf39035"
            };
            currentAppId = 'neew-aec2b';
        }
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
        let currentUser = null;
        let mySymbol = null; 
        let roomId = null;
        let gameState = {
            board: Array(9).fill(null),
            turn: 'X',
            winner: null, 
            players: { X: null, O: null },
            lastMoveTime: 0
        };
        let unsubscribe = null;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ØµÙˆØ§Øª
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;

            if (type === 'click') { // ØµÙˆØª Ø®ÙÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gainNode.gain.setValueAtTime(0.05, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start();
                osc.stop(now + 0.1);
            } else if (type === 'move') { // ØµÙˆØª Ø§Ù„Ø­Ø±ÙƒØ©
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(500, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start();
                osc.stop(now + 0.2);
            } else if (type === 'win') { // Ù†ØºÙ…Ø© Ø§Ù„ÙÙˆØ²
                osc.type = 'square';
                // ØªØªØ§Ø¨Ø¹ÙŠØ© Ø¨Ø³ÙŠØ·Ø©
                osc.frequency.setValueAtTime(523.25, now); // C5
                osc.frequency.setValueAtTime(659.25, now + 0.1); // E5
                osc.frequency.setValueAtTime(783.99, now + 0.2); // G5
                osc.frequency.setValueAtTime(1046.50, now + 0.4); // C6
                gainNode.gain.setValueAtTime(0.05, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.8);
                osc.start();
                osc.stop(now + 0.8);
            } else if (type === 'lose') { // Ù†ØºÙ…Ø© Ø§Ù„Ø®Ø³Ø§Ø±Ø©
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.5);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start();
                osc.stop(now + 0.5);
            }
        }

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØºØ±ÙØ© ÙˆØ§Ù„Ø±Ø§Ø¨Ø· ---
        window.generateRoomId = () => {
            const randomId = Math.floor(1000 + Math.random() * 9000);
            document.getElementById('room-id').value = randomId;
            playSound('click');
        };

        // ÙØ­Øµ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØºØ±ÙØ©
        function checkUrlForRoom() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            if (roomParam) {
                document.getElementById('room-id').value = roomParam;
                // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ø£Ø±Ø¯Ù†Ø§ (Ù…ØªÙ‚Ø¯Ù…)
            }
        }

        window.copyInviteLink = () => {
            const currentUrl = window.location.href.split('?')[0];
            const inviteUrl = `${currentUrl}?room=${roomId}`;
            
            navigator.clipboard.writeText(inviteUrl).then(() => {
                showToast("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©! Ø£Ø±Ø³Ù„Ù‡ Ù„ØµØ¯ÙŠÙ‚Ùƒ");
            }).catch(() => {
                // Fallback for some browsers
                const input = document.createElement('input');
                input.value = inviteUrl;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!");
            });
        };

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        // --- Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                let errorMsg = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: " + error.message;
                // ØªØ­Ø³ÙŠÙ† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£
                if (error.code === 'auth/operation-not-allowed') errorMsg = "Ø®Ø·Ø£: Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ ØºÙŠØ± Ù…ÙØ¹Ù„.";
                if (error.code === 'auth/unauthorized-domain') errorMsg = "Ø®Ø·Ø£: Ø§Ù„Ù†Ø·Ø§Ù‚ ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡.";
                
                showError(errorMsg);
                document.getElementById('btn-text').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
                document.getElementById('btn-loader').classList.add('hidden');
            }
        };

        initAuth();
        checkUrlForRoom();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const loginBtn = document.getElementById('login-btn');
                const btnText = document.getElementById('btn-text');
                const btnLoader = document.getElementById('btn-loader');
                
                btnText.innerText = "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©";
                btnLoader.classList.add('hidden');
                loginBtn.disabled = false;
                loginBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                document.getElementById('login-error').classList.add('hidden');
            }
        });

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        window.selectSymbol = (symbol) => {
            mySymbol = symbol;
            playSound('click');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ØªØ§ÙŠÙ„
            const btnX = document.getElementById('btn-choice-x');
            const btnO = document.getElementById('btn-choice-o');
            
            if (symbol === 'X') {
                btnX.className = "flex-1 py-4 bg-gray-700/80 rounded-xl border-2 border-red-500 shadow-[0_0_20px_rgba(239,68,68,0.3)] transform scale-105 transition duration-300";
                btnX.querySelector('span').className = "relative z-10 text-3xl font-black text-red-500";
                
                btnO.className = "flex-1 py-4 bg-gray-800/30 rounded-xl border-2 border-transparent opacity-60 hover:opacity-100 transition duration-300";
                btnO.querySelector('span').className = "relative z-10 text-3xl font-black text-gray-600";
                
                document.getElementById('selected-symbol-text').innerHTML = `Ø³ØªÙ„Ø¹Ø¨ Ø¨Ø±Ù…Ø² <span class="text-red-500 font-bold">X</span>`;
            } else {
                btnO.className = "flex-1 py-4 bg-gray-700/80 rounded-xl border-2 border-green-500 shadow-[0_0_20px_rgba(16,185,129,0.3)] transform scale-105 transition duration-300";
                btnO.querySelector('span').className = "relative z-10 text-3xl font-black text-green-500";
                
                btnX.className = "flex-1 py-4 bg-gray-800/30 rounded-xl border-2 border-transparent opacity-60 hover:opacity-100 transition duration-300";
                btnX.querySelector('span').className = "relative z-10 text-3xl font-black text-gray-600";
                
                document.getElementById('selected-symbol-text').innerHTML = `Ø³ØªÙ„Ø¹Ø¨ Ø¨Ø±Ù…Ø² <span class="text-green-500 font-bold">O</span>`;
            }
        };

        window.joinGame = async () => {
            playSound('click');
            const inputRoomId = document.getElementById('room-id').value.trim();
            
            if (!inputRoomId) {
                showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ ØªÙˆÙ„ÙŠØ¯Ù‡");
                return;
            }
            if (!mySymbol) {
                showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØ±ÙŠÙ‚Ùƒ (X Ø£Ùˆ O)");
                return;
            }
            if (!currentUser) {
                return;
            }

            roomId = inputRoomId;
            const gameRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'tictactoe_games', roomId);

            // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = true;
            document.getElementById('btn-text').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...";
            document.getElementById('btn-loader').classList.remove('hidden');

            try {
                let docSnap;
                try {
                    docSnap = await getDoc(gameRef);
                } catch (e) {
                    // Ø¥Ø°Ø§ ÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯)ØŒ Ù†Ø¹Ø§Ù…Ù„Ù‡ ÙƒØ¬Ø¯ÙŠØ¯
                    docSnap = { exists: () => false };
                }
                
                if (!docSnap.exists()) {
                    // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                    await setDoc(gameRef, {
                        board: Array(9).fill(null),
                        turn: 'X',
                        winner: null,
                        players: {
                            [mySymbol]: currentUser.uid,
                            [mySymbol === 'X' ? 'O' : 'X']: null
                        },
                        lastMoveTime: Date.now()
                    });
                } else {
                    // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©
                    const data = docSnap.data();
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù…Ø² Ù…Ø­Ø¬ÙˆØ²Ø§Ù‹ Ù„Ø´Ø®Øµ Ø¢Ø®Ø±
                    if (data.players[mySymbol] && data.players[mySymbol] !== currentUser.uid) {
                        showError(`Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø±Ù…Ø² ${mySymbol} Ù…Ø£Ø®ÙˆØ° Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ØºØ±ÙØ© ${roomId}. Ø¬Ø±Ø¨ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¢Ø®Ø±.`);
                        loginBtn.disabled = false;
                        document.getElementById('btn-text').innerText = "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©";
                        document.getElementById('btn-loader').classList.add('hidden');
                        return;
                    }
                    
                    // Ø­Ø¬Ø² Ø§Ù„Ù…ÙƒØ§Ù† Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹
                    if (!data.players[mySymbol]) {
                        await updateDoc(gameRef, {
                            [`players.${mySymbol}`]: currentUser.uid
                        });
                    }
                }

                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                startGameListener();
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                document.getElementById('game-screen').classList.add('flex');
                
                document.getElementById('room-display').innerText = roomId;
                document.getElementById('my-symbol-display').innerText = mySymbol;
                document.getElementById('my-symbol-display').className = `text-4xl font-black ${mySymbol === 'X' ? 'text-red-500' : 'text-green-500'}`;
                
                createBoard();
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
                try {
                    const newUrl = `${window.location.pathname}?room=${roomId}`;
                    window.history.pushState({}, '', newUrl);
                } catch (e) {
                    console.warn("Could not update URL history:", e);
                }

            } catch (err) {
                console.error("Join Error:", err);
                showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹");
                loginBtn.disabled = false;
                document.getElementById('btn-text').innerText = "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©";
                document.getElementById('btn-loader').classList.add('hidden');
            }
        };

        function showError(msg) {
            const errEl = document.getElementById('login-error');
            const txtEl = document.getElementById('error-text');
            txtEl.innerText = msg;
            errEl.classList.remove('hidden');
            playSound('lose'); // ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡
        }

        function createBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell rounded-xl flex items-center justify-center text-5xl font-black cursor-pointer h-full w-full select-none relative overflow-hidden';
                cell.dataset.index = i;
                cell.onclick = () => makeMove(i);
                boardEl.appendChild(cell);
            }
        }

        async function makeMove(index) {
            if (!gameState) return;
            if (gameState.board[index] !== null) return; 
            if (gameState.winner) return; 
            if (gameState.turn !== mySymbol) {
                showToast("Ù„ÙŠØ³ Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†!");
                return; 
            }

            const opponentSymbol = mySymbol === 'X' ? 'O' : 'X';
            if (!gameState.players[opponentSymbol]) {
                // Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ Ù„Ù„ØªØ¬Ø±Ø¨Ø©ØŒ Ù„ÙƒÙ† Ù†Ù†Ø¨Ù‡
                // showToast("Ø§Ù„Ø®ØµÙ… Ù„Ù… ÙŠØ¯Ø®Ù„ Ø¨Ø¹Ø¯ØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù„Ø¹Ø¨");
            }

            const newBoard = [...gameState.board];
            newBoard[index] = mySymbol;
            
            const winner = checkWinner(newBoard);
            const nextTurn = mySymbol === 'X' ? 'O' : 'X';

            const gameRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'tictactoe_games', roomId);
            
            playSound('move');

            try {
                await updateDoc(gameRef, {
                    board: newBoard,
                    turn: nextTurn,
                    winner: winner,
                    lastMoveTime: Date.now()
                });
            } catch (e) {
                console.error("Move Error:", e);
            }
        }

        function checkWinner(board) {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], 
                [0, 3, 6], [1, 4, 7], [2, 5, 8], 
                [0, 4, 8], [2, 4, 6]             
            ];

            for (let line of lines) {
                const [a, b, c] = line;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a];
                }
            }

            if (!board.includes(null)) return 'draw';
            return null;
        }

        function startGameListener() {
            const gameRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'tictactoe_games', roomId);
            
            unsubscribe = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) return;
                
                const data = docSnap.data();
                gameState = data;
                updateUI();
            });
        }

        function updateUI() {
            const cells = document.querySelectorAll('.cell');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙˆØ±Ø¯
            gameState.board.forEach((val, idx) => {
                const cell = cells[idx];
                cell.innerText = val || '';
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·
                cell.className = 'cell rounded-xl flex items-center justify-center text-5xl font-black cursor-pointer h-full w-full select-none relative overflow-hidden';
                
                if (val) {
                    cell.classList.add('occupied');
                    if (val === 'X') cell.classList.add('x-mark');
                    else cell.classList.add('o-mark');
                }
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø®ØµÙ…
            const turnIndicator = document.getElementById('turn-indicator');
            const opponentStatus = document.getElementById('opponent-status');
            const inviteSection = document.getElementById('invite-section');

            const opponentSymbol = mySymbol === 'X' ? 'O' : 'X';
            const opponentId = gameState.players[opponentSymbol];

            if (!opponentId) {
                opponentStatus.innerHTML = `<div class="loader w-4 h-4 border-2 border-yellow-500 border-t-transparent"></div> Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø®ØµÙ…...`;
                opponentStatus.className = "glass-panel inline-flex items-center gap-2 px-6 py-2 rounded-full text-sm font-medium text-yellow-400 animate-pulse";
                inviteSection.classList.remove('hidden'); // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¯Ø¹ÙˆØ©
                
                turnIndicator.innerHTML = `<span class="text-gray-400">Ù†Ù†ØªØ¸Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</span>`;
            } else {
                opponentStatus.innerHTML = `<i class="fas fa-wifi text-green-500 text-xs"></i> Ø§Ù„Ø®ØµÙ… Ù…ØªØµÙ„`;
                opponentStatus.className = "glass-panel inline-flex items-center gap-2 px-6 py-2 rounded-full text-sm font-medium text-green-400 border-green-500/30";
                inviteSection.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„Ø£Ù† Ø§Ù„Ø®ØµÙ… ÙˆØµÙ„
                
                if (gameState.winner) {
                     turnIndicator.innerHTML = `<span class="text-white">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</span>`;
                } else if (gameState.turn === mySymbol) {
                    turnIndicator.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> <span class="text-green-400">Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†</span>`;
                    turnIndicator.parentElement.className = "bg-green-900/40 px-6 py-2 rounded-full border border-green-500/50 backdrop-blur-sm transition-all shadow-[0_0_15px_rgba(16,185,129,0.2)]";
                } else {
                    turnIndicator.innerHTML = `<span class="w-2 h-2 bg-red-500 rounded-full"></span> <span class="text-red-400">Ø¯ÙˆØ± Ø§Ù„Ø®ØµÙ…</span>`;
                    turnIndicator.parentElement.className = "bg-red-900/20 px-6 py-2 rounded-full border border-red-500/20 backdrop-blur-sm transition-all";
                }
            }

            if (gameState.winner) {
                handleGameEnd(gameState.winner);
            } else {
                document.getElementById('result-modal').classList.add('hidden');
            }
        }

        function handleGameEnd(winner) {
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('result-title');
            const msg = document.getElementById('result-message');
            const icon = document.getElementById('result-icon');
            
            modal.classList.remove('hidden');
            
            if (winner === 'draw') {
                icon.innerText = "ğŸ¤";
                title.innerText = "ØªØ¹Ø§Ø¯Ù„!";
                title.className = "text-3xl font-black mb-2 text-gray-300";
                msg.innerText = "Ù…Ù†Ø§ÙØ³Ø© Ù‚ÙˆÙŠØ©ØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ§Ø¦Ø².";
            } else if (winner === mySymbol) {
                icon.innerText = "ğŸ‘‘";
                title.innerText = "Ø£Ù†Øª Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©!";
                title.className = "text-4xl font-black mb-2 text-yellow-400 drop-shadow-lg";
                msg.innerText = "Ù„Ù‚Ø¯ Ø³Ø­Ù‚Øª Ø®ØµÙ…Ùƒ Ø¨Ø¬Ø¯Ø§Ø±Ø©.";
                playSound('win');
                highlightWinningCells();
            } else {
                icon.innerText = "ğŸ’€";
                title.innerText = "Ø®Ø³Ø§Ø±Ø©...";
                title.className = "text-3xl font-black mb-2 text-red-500";
                msg.innerText = "Ø­Ø¸ Ø£ÙˆÙØ± ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.";
                playSound('lose');
                highlightWinningCells();
            }
        }

        function highlightWinningCells() {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], 
                [0, 3, 6], [1, 4, 7], [2, 5, 8], 
                [0, 4, 8], [2, 4, 6]
            ];
            const cells = document.querySelectorAll('.cell');
            
            for (let line of lines) {
                const [a, b, c] = line;
                if (gameState.board[a] && gameState.board[a] === gameState.board[b] && gameState.board[a] === gameState.board[c]) {
                    // ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø³ÙŠØ·
                    setTimeout(() => cells[a].classList.add('winning-cell'), 0);
                    setTimeout(() => cells[b].classList.add('winning-cell'), 100);
                    setTimeout(() => cells[c].classList.add('winning-cell'), 200);
                }
            }
        }

        window.resetGame = async () => {
             const gameRef = doc(db, 'artifacts', currentAppId, 'public', 'data', 'tictactoe_games', roomId);
             try {
                 await updateDoc(gameRef, {
                     board: Array(9).fill(null),
                     turn: 'X', 
                     winner: null,
                     lastMoveTime: Date.now()
                 });
             } catch(e) {
                 console.error("Reset Game Error:", e);
             }
        };
    </script>
</body>
</html>
